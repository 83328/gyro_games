<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gyro Games</title>
  <style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e6f0ff;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:100vh;margin:0;padding-top:18px;overflow:auto}
    .card{background:#0f1724;padding:20px;border-radius:8px;border:1px solid #223;background-clip:padding-box;box-shadow:0 6px 18px rgba(0,0,0,0.6);width:320px;max-width:90%}
    h1{margin:0 0 12px 0;font-size:20px}
    a.btn{display:block;text-decoration:none;padding:10px 12px;margin:8px 0;background:#1f6feb;color:#fff;border-radius:6px;text-align:center}
    a.btn.secondary{background:#ff6b6b}
    p.small{font-size:12px;color:#a8b4d6;margin:8px 0 0}
   /* thumbnail sizing: keep a max ratio of 4:3 by making the thumb container 4:3
     and letting the image cover the box. This prevents very wide images on desktop. */
  .thumb{ display:block; aspect-ratio: 4 / 3; overflow:hidden; border-radius:6px; background:#0b0b0b; position:relative; min-height:120px }
  .thumb img.thumb-img{ width:100%; height:100%; object-fit:cover; object-position:center center; display:block }
  /* overlay label on image */
  .thumb .overlay{ position:absolute; left:0; right:0; bottom:0; padding:8px 10px; color:#eef; font-weight:600; text-align:center; background:linear-gradient(rgba(0,0,0,0.0), rgba(0,0,0,0.6)); }
  @media(min-width:900px){ .card { width:560px } .thumb-grid{ grid-template-columns: repeat(3, 1fr); gap:8px } }
  </style>
</head>
<body>
  <!-- Room ID and Player Count display -->
  <div class="card" style="text-align:center; margin-bottom:10px;">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;">
      <div style="font-size:18px; font-weight:600; color:#ffd86b; letter-spacing:2px;">Room ID: <span id="roomIdDisplay"></span></div>
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="playerCount" style="font-size:14px;color:#a8b4d6;">Players:</label>
        <select id="playerCount" style="padding:4px 8px;border-radius:4px;background:#1f1f1f;color:#fff;border:1px solid #333;">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
        </select>
      </div>
      <a id="addControllerBtn" class="btn secondary" style="padding:6px 14px;font-size:13px;margin:0;" href="#">Add Controller</a>
    </div>
  </div>
  <div class="card" style="text-align:center">
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;flex-direction:column">
      <img id="qrImg" alt="QR code" style="width:200px;height:200px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#fff" src="" />
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
  <button id="copyLink" class="btn" style="padding:.4rem .6rem">Copy link</button>
      </div>
      <div style="font-size:12px;color:#a8b4d6;margin-top:6px">Scan to open the controller on your phone</div>
    </div>
  </div>
  <div class="card">
    <h1>Games</h1>
    <div class="thumb-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
  <a class="thumb" href="/maze.html" title="Maze Runner"><img class="thumb-img" src="/media/images/thumb_maze.png" alt="Maze Runner thumbnail"/><div class="overlay">Maze Runner</div></a>
  <a class="thumb" href="/blob.html" title="Blob Eaters"><img class="thumb-img" src="/media/images/thumb_blob.png" alt="Blob Eaters thumbnail"/><div class="overlay">Blob Eaters</div></a>
  <a class="thumb" href="/lander.html" title="Lander"><img class="thumb-img" src="/media/images/thumb_lander.png" alt="Lander thumbnail"/><div class="overlay">Lander</div></a>
  <a class="thumb" href="/sumo.html" title="Gyro Sumo"><img class="thumb-img" src="/media/images/thumb_sumo.png" alt="Gyro Sumo thumbnail"/><div class="overlay">Gyro Sumo</div></a>
  <a class="thumb" href="/turtle.html" title="Turtle Race"><img class="thumb-img" src="/media/images/thumb_turtle.png" alt="Turtle Race thumbnail"/><div class="overlay">Turtle Race</div></a>
  <a class="thumb" href="/paint.html" title="Paint"><img class="thumb-img" src="/media/images/thumb_paint.png" alt="Paint thumbnail"/><div class="overlay">Paint</div></a>
  <a class="thumb" href="/sweepers.html" title="Asteroid Sweepers"><img class="thumb-img" src="/media/images/thumb_sweepers.png" alt="Asteroid Sweepers thumbnail"/><div class="overlay">Asteroid Sweepers</div></a>
  <!-- <a class="thumb" href="/pong.html" title="Pong"><img class="thumb-img" src="/media/images/thumb_pong.png" alt="Pong thumbnail"/><div class="overlay">Pong</div></a> -->
  <a class="thumb" href="/blackhole.html" title="Blasters"><img class="thumb-img" src="/media/images/thumb_blackhole.png" alt="Blasters thumbnail"/><div class="overlay">Blasters</div></a>
    </div>
  </div>
</body>
<script>
  // Generate a random three-letter room code
  function randomRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let code = '';
    for (let i = 0; i < 3; ++i) code += chars[Math.floor(Math.random() * chars.length)];
    return code;
  }

  // Persist room code in sessionStorage so back navigation keeps it.
  // On an explicit reload we allow generating a fresh code.
  const nav = performance.getEntriesByType('navigation')[0];
  const isReload = nav && nav.type === 'reload';
  let stored = null;
  try { stored = sessionStorage.getItem('roomCode'); } catch (e) { stored = null; }
  let roomCode = stored && !isReload ? stored : randomRoomCode();
  try { sessionStorage.setItem('roomCode', roomCode); } catch (e) {}
  // Show room code in the page
  document.addEventListener('DOMContentLoaded', function() {
    const roomIdDisplay = document.getElementById('roomIdDisplay');
    if (roomIdDisplay) roomIdDisplay.textContent = roomCode;
  });

  const qrImg = document.getElementById('qrImg');
  const copyBtn = document.getElementById('copyLink');
  const addControllerBtn = document.getElementById('addControllerBtn');
  const playerCountSelect = document.getElementById('playerCount');

  let ws = null; // WebSocket connection for broadcasting room metadata

  // Connect to WebSocket to broadcast player count for this room
  function connectWebSocket() {
    fetch('/api/token')
      .then(response => response.json())
      .then(data => {
        const token = data.token;
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        const wsUrl = `${proto}://${location.host}/ws?token=${encodeURIComponent(token)}&room=${roomCode}`;
        
        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          console.log('[Index] WebSocket connected to room', roomCode);
          // Announce the current player count for this room
          try {
            ws.send(JSON.stringify({ type: 'room-meta', playerCount: parseInt(playerCountSelect.value, 10), t: Date.now() }));
          } catch (e) { /* best-effort */ }
        };
        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            // If someone requests meta, reply with our player count
            if (data && data.type === 'request-meta') {
              try {
                ws.send(JSON.stringify({ type: 'room-meta', playerCount: parseInt(playerCountSelect.value, 10), t: Date.now() }));
              } catch (e) { /* best-effort */ }
            }
          } catch (e) { /* ignore */ }
        };
        ws.onclose = () => {
          console.log('[Index] WebSocket disconnected');
          ws = null;
          // Reconnect after a delay
          setTimeout(connectWebSocket, 5000);
        };
        ws.onerror = (e) => {
          console.log('[Index] WebSocket error');
        };
      })
      .catch(err => {
        console.log('[Index] Failed to connect WebSocket:', err);
      });
  }

  // Start WebSocket connection
  connectWebSocket();

  // Build a URL to the streaming page with ?room=ROOMCODE&players=N
  function buildUrl(){
    const players = playerCountSelect.value;
    return `https://games.arthurlimpens.com/gyro.html?room=${roomCode}&players=${players}`;
  }
  function updateGameLinks() {
    const players = playerCountSelect.value;
    const links = document.querySelectorAll('.thumb-grid a');
    links.forEach(link => {
      const url = new URL(link.getAttribute('href'), location.origin);
      url.searchParams.set('room', roomCode);
      url.searchParams.set('players', players);
      link.setAttribute('href', url.pathname + url.search);
    });
  }
  
  // Update links when player count changes
  playerCountSelect.addEventListener('change', () => {
    updateGameLinks();
    updateQr();
    // Broadcast the new player count to the room via websocket if connected
    if (ws && ws.readyState === WebSocket.OPEN) {
      try {
        ws.send(JSON.stringify({ type: 'room-meta', playerCount: parseInt(playerCountSelect.value, 10), t: Date.now() }));
      } catch (e) { /* best-effort */ }
    }
  });
  
  updateGameLinks();
  function updateQr(){
    const u = buildUrl();
    // api.qrserver.com generates a PNG for free and supports size param
    const src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(u)}`;
    qrImg.src = src;
    qrImg.title = u;
    // Update Add Controller button link
    const players = playerCountSelect.value;
    if (addControllerBtn) addControllerBtn.setAttribute('href', `/gyro.html?room=${roomCode}&players=${players}`);
  }
  // Removed useRoot checkbox
  copyBtn.addEventListener('click', ()=>{ navigator.clipboard?.writeText(buildUrl()).then(()=>{ copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy link',1200); }); });
  updateQr();
</script>
</html>
